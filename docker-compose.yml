version: '3.7'

services:
  ns:
    #image: cznic/knot:latest  # does not support ed448
    build: knot-dns
    volumes:
    - ./keys:/fixed-keys
    - ns_storage:/storage
    - ns_rundir:/rundir
    - ./ns/config:/config
    - ./addtestzones.sh:/root/bin/addtestzones.sh
    - ./addagilezone.sh:/root/bin/addagilezone.sh
    - ./ns/entrypoint.sh:/entrypoint.sh
    ports:
    - "${IP_NS1}:53:53/udp"
    - "${IP_NS1}:53:53/tcp"
    - "${IP_NS2}:53:53/udp"
    - "${IP_NS2}:53:53/tcp"
    command: /entrypoint.sh
    networks:
    - backend
    restart: unless-stopped
  fns:
    build: fns
    volumes:
    - ./fns/:/fns
    - ./analysis/:/data/
    ports:
    - "${IP_AGILE_NS1}:53:53/udp"
    - "${IP_AGILE_NS1}:53:53/tcp"
    - "${IP_AGILE_NS2}:53:53/udp"
    - "${IP_AGILE_NS2}:53:53/tcp"
    environment:
      ADNSSEC_UPSTREAM_HOST: ns
      ADNSSEC_UPSTREAM_PORT: 53
      ADNSSEC_ML: 1
    networks:
    - backend
    command: python3 /fns/fns.py
    restart: unless-stopped
    init: true

networks:
  backend:

volumes:
  ns_storage:
  ns_config:
  ns_rundir:
