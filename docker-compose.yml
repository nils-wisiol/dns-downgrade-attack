version: '3.7'

services:
  nsa:
    #image: cznic/knot:latest  # does not support ed448
    build: knot-dns
    volumes:
    - ./keys:/fixed-keys
    - nsa_storage:/storage
    - nsa_rundir:/rundir
    - ./ns/config:/config
    - ./addtestzones.sh:/root/bin/addtestzones.sh
    - ./addagilezone.sh:/root/bin/addagilezone.sh
    - ./ns/entrypoint.sh:/entrypoint.sh
    ports:
    - "${IP_NS_A_1}:53:53/udp"
    - "${IP_NS_A_1}:53:53/tcp"
    - "${IP_NS_A_2}:53:53/udp"
    - "${IP_NS_A_2}:53:53/tcp"
    environment:
      - ZONE
      - A_RECORD
      - IP_NS_A_1
      - IP_NS_A_2
      - IP_NS_B_1
      - IP_NS_B_AGILE_1
    command: /entrypoint.sh
    networks:
    - backend
    restart: unless-stopped
  nsb:
    #image: cznic/knot:latest  # does not support ed448
    build: knot-dns
    volumes:
    - ./keys:/fixed-keys
    - nsb_storage:/storage
    - nsb_rundir:/rundir
    - ./ns/config:/config
    - ./addtestzones.sh:/root/bin/addtestzones.sh
    - ./addagilezone.sh:/root/bin/addagilezone.sh
    - ./ns/entrypoint.sh:/entrypoint.sh
    ports:
    - "${IP_NS_B_1}:53:53/udp"
    - "${IP_NS_B_1}:53:53/tcp"
    environment:
      - ZONE
      - A_RECORD
      - IP_NS_A_1
      - IP_NS_A_2
      - IP_NS_B_1
      - IP_NS_B_AGILE_1
    command: /entrypoint.sh
    networks:
    - backend
    restart: unless-stopped
  fns:
    build: fns
    volumes:
    - ./fns/:/fns
    - ./analysis/:/data/
    ports:
    - "${IP_NS_B_AGILE_1}:53:53/udp"
    - "${IP_NS_B_AGILE_1}:53:53/tcp"
    environment:
      ADNSSEC_UPSTREAM_HOST: nsb
      ADNSSEC_UPSTREAM_PORT: 53
      ADNSSEC_ML: 1
      ADNSSEC_NUM_PROCESSES: $ADNSSEC_NUM_PROCESSES
    networks:
    - backend
    command: python3 /fns/fns.py
    restart: unless-stopped
    init: true

networks:
  backend:

volumes:
  nsa_storage:
  nsa_rundir:
  nsb_storage:
  nsb_rundir:
